<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteo de la Copa del Mundo - Panel de Control 2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #000000 0%, #001a4d 100%);
            color: #ffffff;
            padding: 12px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            flex: 1;
            height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 2.3rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 4px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.2rem;
            }
        }

        .header p {
            font-size: 0.95rem;
            color: #aaa;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .controls {
                gap: 6px;
                margin-bottom: 8px;
            }
        }

        @media (max-width: 480px) {
            .controls {
                gap: 4px;
                margin-bottom: 6px;
            }
        }

        .btn {
            padding: 14px 28px;
            font-size: 1.05rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        @media (max-width: 768px) {
            .btn {
                padding: 10px 16px;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .btn {
                padding: 8px 12px;
                font-size: 0.75rem;
            }
        }

        .btn-save {
            background: #ffffff;
            color: #000000;
        }

        .btn-save:hover {
            background: #e0e0e0;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }

        .btn-clear {
            background: #ffffff;
            color: #000000;
        }

        .btn-clear:hover {
            background: #e0e0e0;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }

        .groups-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            flex: 1;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .groups-grid {
                grid-template-columns: repeat(2, 1fr);
                overflow-y: auto;
            }
        }

        @media (max-width: 480px) {
            .groups-grid {
                grid-template-columns: 1fr;
                overflow-y: auto;
            }
        }

        .group-panel {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid #ffffff;
            border-radius: 10px;
            padding: 12px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .group-panel.highlighted {
            background: rgba(0, 217, 255, 0.2);
            border-color: #00d9ff;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.5);
        }

        .group-panel h3 {
            font-size: 1.25rem;
            color: #ffffff;
            margin-bottom: 8px;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 2px solid #ffffff;
            flex-shrink: 0;
        }

        .input-group {
            margin-bottom: 8px;
            position: relative;
            flex-shrink: 0;
        }

        .input-group label {
            display: none;
            font-size: 0.7rem;
            color: #aaa;
            margin-bottom: 2px;
        }

        .team-input {
            width: 100%;
            padding: 10px;
            font-size: 0.95rem;
            font-family: 'Poppins', sans-serif;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #ffffff;
            border-radius: 4px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .team-input:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .team-input:focus {
            outline: none;
            border-color: #00d9ff;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .team-input::placeholder {
            color: #666;
        }

        .team-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .team-input-wrapper .team-input {
            flex: 1;
        }

        .team-input-flag {
            width: 32px;
            height: 20px;
            border-radius: 2px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: rgba(26, 26, 26, 0.95);
            border: 2px solid #ffffff;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0, 217, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: #ffffff;
        }

        .close-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            color: #00d9ff;
        }

        .modal-search {
            padding: 15px 20px;
            border-bottom: 1px solid #333;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #ffffff;
            border-radius: 6px;
            color: #ffffff;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #00d9ff;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .search-input::placeholder {
            color: #666;
        }

        .modal-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .team-item {
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .team-item:hover {
            background: rgba(0, 217, 255, 0.1);
        }

        .team-item:last-child {
            border-bottom: none;
        }

        .team-flag {
            width: 40px;
            height: 25px;
            border-radius: 3px;
            flex-shrink: 0;
            object-fit: cover;
        }

        .status-message {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none;
        }

        .status-message.success {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #ffffff;
            color: #ffffff;
            display: block;
        }

        .status-message.error {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #ffffff;
            color: #ffffff;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="blencadlogo.png" alt="Blencad Logo" style="height: 60px; margin-bottom: 12px; filter: drop-shadow(0 0 10px rgba(0, 217, 255, 0.3));">
            <h1>Sorteo de la Copa del Mundo - Panel de Control 2</h1>
            <p>Haz clic en cada equipo para seleccionar desde la lista. Los cambios se sincronizan automáticamente con la pantalla.</p>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <div class="controls">
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="bomboSelector" style="font-size: 1rem; font-weight: 600;">Bombo:</label>
                <select id="bomboSelector" class="btn" style="padding: 15px 30px; cursor: pointer;" onchange="setBombo()">
                    <option value="1">Bombo 1</option>
                    <option value="2">Bombo 2</option>
                    <option value="3">Bombo 3</option>
                    <option value="4">Bombo 4</option>
                </select>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="groupSelector" style="font-size: 1rem; font-weight: 600;">Destacar Grupo:</label>
                <select id="groupSelector" class="btn" style="padding: 15px 30px; cursor: pointer;" onchange="setHighlightedGroup()">
                    <option value="">Ninguno</option>
                    <option value="A">Grupo A</option>
                    <option value="B">Grupo B</option>
                    <option value="C">Grupo C</option>
                    <option value="D">Grupo D</option>
                    <option value="E">Grupo E</option>
                    <option value="F">Grupo F</option>
                    <option value="G">Grupo G</option>
                    <option value="H">Grupo H</option>
                    <option value="I">Grupo I</option>
                    <option value="J">Grupo J</option>
                    <option value="K">Grupo K</option>
                    <option value="L">Grupo L</option>
                </select>
                <button class="btn btn-save" onclick="nextGroup()">Próximo Grupo</button>
            </div>
            <button class="btn btn-save" onclick="saveChanges()">Guardar Cambios</button>
            <button class="btn btn-clear" onclick="clearAll()">Limpiar Todo</button>
        </div>

        <div class="groups-grid" id="groupsGrid">
        </div>
    </div>

    <div id="teamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Seleccionar Equipo</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-search">
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar equipo..." oninput="filterTeams()">
            </div>
            <div class="modal-list" id="teamList">
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const teams = [
            "Alemania", "A. Saudita", "Argelia", "Argentina", "Australia", "Austria",
            "Bélgica", "Brasil", "Cabo Verde", "Canadá", "Catar", "Colombia",
            "Costa de Marfil", "Croacia", "Curazao", "Ecuador", "Egipto", "Escocia",
            "España", "Estados Unidos", "Francia", "Ghana", "Haití", "Inglaterra",
            "Irán", "Japón", "Jordania", "Marruecos", "México", "Noruega",
            "Nueva Zelanda", "Países Bajos", "Panamá", "Paraguay", "Portugal",
            "República de Corea", "Senegal", "Sudáfrica", "Suiza", "Túnez", "Uruguay", "Uzbekistán",
            "R. EUROPA 1", "R. EUROPA 2", "R. EUROPA 3", "R. EUROPA 4", "R. INTERCONT 1", "R. INTERCONT 2"
        ];

        const countryToCode = {
            "Alemania": "de", "A. Saudita": "sa", "Argelia": "dz", "Argentina": "ar", "Australia": "au",
            "Austria": "at", "Bélgica": "be", "Brasil": "br", "Cabo Verde": "cv", "Canadá": "ca",
            "Catar": "qa", "Colombia": "co", "Costa de Marfil": "ci", "Croacia": "hr", "Curazao": "cw",
            "Ecuador": "ec", "Egipto": "eg", "Escocia": "gb-sct", "España": "es", "Estados Unidos": "us",
            "Francia": "fr", "Ghana": "gh", "Haití": "ht", "Inglaterra": "gb-eng", "Irán": "ir",
            "Japón": "jp", "Jordania": "jo", "Marruecos": "ma", "México": "mx", "Noruega": "no",
            "Nueva Zelanda": "nz", "Países Bajos": "nl", "Panamá": "pa", "Paraguay": "py", "Portugal": "pt",
            "República de Corea": "kr", "Senegal": "sn", "Sudáfrica": "za", "Suiza": "ch", "Túnez": "tn",
            "Uruguay": "uy", "Uzbekistán": "uz",
            "R. EUROPA 1": "fifa", "R. EUROPA 2": "fifa", "R. EUROPA 3": "fifa", "R. EUROPA 4": "fifa",
            "R. INTERCONT 1": "fifa", "R. INTERCONT 2": "fifa"
        };

        const groupLetters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'];
        let currentInput = null;
        let groups = {};
        const socket = io();

        groupLetters.forEach(letter => {
            groups[letter] = ['', '', '', ''];
        });

        socket.on('groups_update', (data) => {
            console.log('Data updated from server');
            groups = JSON.parse(JSON.stringify(data));
            render();
        });

        socket.on('highlighted_group_update', (group) => {
            console.log('Highlighted group updated:', group);
            document.getElementById('groupSelector').value = group;
            updateGroupPanelHighlight(group);
        });

        socket.on('bombo_update', (bomboNumber) => {
            console.log('Bombo updated:', bomboNumber);
            document.getElementById('bomboSelector').value = bomboNumber;
        });

        function setBombo() {
            const selectedBombo = parseInt(document.getElementById('bomboSelector').value);
            socket.emit('set_bombo', selectedBombo);
        }

        function setHighlightedGroup() {
            const selectedGroup = document.getElementById('groupSelector').value;
            socket.emit('set_highlighted_group', selectedGroup);
            updateGroupPanelHighlight(selectedGroup);
        }

        function updateGroupPanelHighlight(group) {
            const panels = document.querySelectorAll('.group-panel');
            panels.forEach(panel => {
                panel.classList.remove('highlighted');
            });
            if (group) {
                const groupPanels = Array.from(panels).filter(panel => 
                    panel.querySelector('h3').textContent === `Grupo ${group}`
                );
                if (groupPanels.length > 0) {
                    groupPanels[0].classList.add('highlighted');
                    groupPanels[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        function nextGroup() {
            const currentGroup = document.getElementById('groupSelector').value;
            const groupLetters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'];
            
            let nextGroupLetter;
            if (!currentGroup || currentGroup === '') {
                nextGroupLetter = 'A';
            } else {
                const currentIndex = groupLetters.indexOf(currentGroup);
                const nextIndex = (currentIndex + 1) % groupLetters.length;
                nextGroupLetter = groupLetters[nextIndex];
            }
            
            document.getElementById('groupSelector').value = nextGroupLetter;
            socket.emit('set_highlighted_group', nextGroupLetter);
        }

        function openModal(inputElement, index) {
            currentInput = { element: inputElement, groupIndex: index };
            document.getElementById('teamModal').classList.add('show');
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInput').focus();
            renderTeamList(teams);
        }

        function closeModal() {
            document.getElementById('teamModal').classList.remove('show');
            currentInput = null;
        }

        function renderTeamList(filteredTeams) {
            const list = document.getElementById('teamList');
            list.innerHTML = '';
            filteredTeams.forEach(team => {
                const item = document.createElement('div');
                item.className = 'team-item';
                
                const flag = document.createElement('img');
                flag.className = 'team-flag';
                if (countryToCode[team]) {
                    flag.src = `/w2560/${countryToCode[team]}.png`;
                }
                flag.alt = team;
                
                const name = document.createElement('span');
                name.textContent = team;
                
                item.appendChild(flag);
                item.appendChild(name);
                item.onclick = () => selectTeam(team);
                list.appendChild(item);
            });
        }

        function filterTeams() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // Separar equipos que empiezan con el término vs que lo contienen en el medio
            const startsWithTerm = teams.filter(team => team.toLowerCase().startsWith(searchTerm));
            const containsTerm = teams.filter(team => 
                team.toLowerCase().includes(searchTerm) && !team.toLowerCase().startsWith(searchTerm)
            );
            
            // Primero mostrar los que empiezan con el término, luego los demás
            const filtered = [...startsWithTerm, ...containsTerm];
            renderTeamList(filtered);
        }

        function selectTeam(team) {
            if (currentInput) {
                const groupLetter = currentInput.element.dataset.group;
                const teamIndex = parseInt(currentInput.element.dataset.index);
                groups[groupLetter][teamIndex] = team;
                currentInput.element.value = team;
                closeModal();
                render();
                socket.emit('update_groups', groups);
            }
        }

        function render() {
            const grid = document.getElementById('groupsGrid');
            grid.innerHTML = '';

            groupLetters.forEach(letter => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group-panel';
                const currentHighlighted = document.getElementById('groupSelector').value;
                if (currentHighlighted === letter) {
                    groupDiv.classList.add('highlighted');
                }
                groupDiv.innerHTML = `<h3>Grupo ${letter}</h3>`;

                groups[letter].forEach((team, index) => {
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'input-group';

                    const label = document.createElement('label');
                    label.textContent = `Equipo ${index + 1}`;

                    const wrapper = document.createElement('div');
                    wrapper.className = 'team-input-wrapper';

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'team-input';
                    input.value = team;
                    input.placeholder = `Selecciona equipo ${index + 1}`;
                    input.readOnly = true;
                    input.dataset.group = letter;
                    input.dataset.index = index;
                    input.onclick = () => openModal(input, index);

                    wrapper.appendChild(input);

                    if (team && countryToCode[team]) {
                        const flag = document.createElement('img');
                        flag.className = 'team-input-flag';
                        flag.src = `/w2560/${countryToCode[team]}.png`;
                        flag.alt = team;
                        wrapper.appendChild(flag);
                    }

                    inputGroup.appendChild(label);
                    inputGroup.appendChild(wrapper);
                    groupDiv.appendChild(inputGroup);
                });

                grid.appendChild(groupDiv);
            });
        }

        function saveChanges() {
            socket.emit('update_groups', groups);
            showStatus('¡Cambios guardados exitosamente!', 'success');
        }

        function clearAll() {
            if (confirm('¿Deseas limpiar todos los equipos?')) {
                groupLetters.forEach(letter => {
                    groups[letter] = ['', '', '', ''];
                });
                socket.emit('update_groups', groups);
                render();
                showStatus('¡Todos los equipos han sido limpiados!', 'success');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            setTimeout(() => {
                statusDiv.className = 'status-message';
            }, 3000);
        }

        document.getElementById('teamModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('teamModal')) {
                closeModal();
            }
        });

        render();
    </script>
</body>
</html>
